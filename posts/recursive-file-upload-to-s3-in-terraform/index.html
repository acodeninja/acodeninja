<!DOCTYPE html>
<html class="light" lang="en"><head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  <meta name="description"
        content="I&amp;rsquo;ve been working a lot with HashiCorp&amp;rsquo;s terraform recently. From learning how to set up a highly available container based infrastructure using AWS ECS , to setting up a CloudFront distribution for a static site hosted on S3 .
One problem I have had to solve a number of times, is uploading the contents of a directory recursively to an S3 bucket. With the help of a post from Andy Dote&amp;rsquo;s blog, I was able to get some files uploaded."
  />
  <meta name="keywords"
        content="software developer, coder, learning to code, terraform, aws s3, recursive upload, infrastructure as code"
  />

  <link rel="canonical" href="/posts/recursive-file-upload-to-s3-in-terraform/" />

  <title>recursive file upload to s3 in terraform | Adventures of a code ninja</title>

  <link rel="stylesheet" media="all" href="/all.css"/>
  <link rel="stylesheet" media="screen" href="/screen.css"/>
  <link rel="stylesheet" media="screen" href="/app.css"/>
</head>
<body><header>
  <nav>
    <a href="/">
      
        adventures of a code ninja
      
    </a>
    <ul>
      
        <li>
          <a href="/posts">
            blog
          </a>
        </li>
      
    </ul>
    <div id="theme-toggle"></div>
  </nav>
</header>
<main>
  <h1>recursive file upload to s3 in terraform</h1>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#creating-the-s3-bucket">creating the S3 bucket</a></li>
    <li><a href="#uploading-multiple-files">uploading multiple files</a></li>
    <li><a href="#no-caveats">no caveats!</a></li>
  </ul>
</nav>
  <br><br>
  <p>I&rsquo;ve been working a lot with <a href="https://www.hashicorp.com/" target="_blank" rel="noreferrer noopener">HashiCorp&rsquo;s</a>

<a href="https://www.hashicorp.com/products/terraform" target="_blank" rel="noreferrer noopener">terraform</a>
 recently. From
learning how to set up a <a href="https://learn.madetech.com/core-skills/infrastructure/" target="_blank" rel="noreferrer noopener">highly available container based infrastructure</a>

using <a href="https://aws.amazon.com/ecs/" target="_blank" rel="noreferrer noopener">AWS ECS</a>
, to setting up a
<a href="https://aws.amazon.com/cloudfront/" target="_blank" rel="noreferrer noopener">CloudFront</a>
 distribution for a static site
hosted on <a href="https://aws.amazon.com/s3/" target="_blank" rel="noreferrer noopener">S3</a>
.</p>
<p>One problem I have had to solve a number of times, is uploading the contents of
a directory recursively to an S3 bucket. With the help of a
<a href="https://andydote.co.uk/2017/04/23/s3-multi-file-upload-terraform/" target="_blank" rel="noreferrer noopener">post</a>
 from
Andy Dote&rsquo;s blog, I was able to get some files uploaded. However I didn&rsquo;t like
the idea of writing a .tf file from a bash script, so I wanted do this
completely inside terraform.</p>
<h2 id="creating-the-s3-bucket">creating the S3 bucket</h2>
<p>To begin with, we need an S3 bucket defined in our terraform project. The code
block below comes with a website block that sets up web hosting for the bucket.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_s3_bucket&#34; &#34;s3_static&#34;</span> {
  bucket  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;testing-website-static-hosting&#34;</span>
  acl     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;public-read&#34;</span>

  <span style="color:#66d9ef">website</span> {
    index_document <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;index.html&#34;</span>
    error_document <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;error.html&#34;</span>
  }
}
</code></pre></div><h2 id="uploading-multiple-files">uploading multiple files</h2>
<p>Now we need get a set of files from a local directory containing the website
using the <a href="https://www.terraform.io/docs/configuration/functions/fileset.html" target="_blank" rel="noreferrer noopener">fileset</a>

function.</p>
<p>We then feed that into the <code>for_each</code> to iterate over the set of files and
directories matched by the glob. We then continue much in the same way we did in
Andy&rsquo;s post, but leveraging the <code>each.value</code> property in place of the full
filename.</p>
<p>The mimetypes variable is used with the file extension taken from the file
path split on <code>.</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;upload_directory&#34;</span> {
  default <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${path.cwd}/codebases/website-static/&#34;</span>
}

<span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;mime_types&#34;</span> {
  default <span style="color:#f92672">=</span> {
    htm   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;text/html&#34;</span>
    html  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;text/html&#34;</span>
    css   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;text/css&#34;</span>
    ttf   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;font/ttf&#34;</span>
    js    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;application/javascript&#34;</span>
    map   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;application/javascript&#34;</span>
    json  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;application/json&#34;</span>
  }
}

<span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_s3_bucket_object&#34; &#34;website_files&#34;</span> {
  for_each      <span style="color:#f92672">=</span> <span style="color:#66d9ef">fileset</span>(<span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">upload_directory</span>, <span style="color:#e6db74">&#34;**/*.*&#34;</span>)
  bucket        <span style="color:#f92672">=</span> <span style="color:#66d9ef">aws_s3_bucket</span>.<span style="color:#66d9ef">s3_static</span>.<span style="color:#66d9ef">bucket</span>
  key           <span style="color:#f92672">=</span> <span style="color:#66d9ef">replace</span>(<span style="color:#66d9ef">each</span>.<span style="color:#66d9ef">value</span>, <span style="color:#66d9ef">var</span>.<span style="color:#66d9ef">upload_directory</span>, <span style="color:#e6db74">&#34;&#34;</span>)
  source        <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${var.upload_directory}${each.value}&#34;</span>
  acl           <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;public-read&#34;</span>
  etag          <span style="color:#f92672">=</span> <span style="color:#66d9ef">filemd5</span>(<span style="color:#e6db74">&#34;${var.upload_directory}${each.value}&#34;</span>)
  content_type  <span style="color:#f92672">=</span> <span style="color:#66d9ef">lookup</span>(<span style="color:#66d9ef">local</span>.<span style="color:#66d9ef">mime_types</span>, <span style="color:#66d9ef">split</span>(<span style="color:#e6db74">&#34;.&#34;, each.value)[length(split(&#34;.&#34;</span>, <span style="color:#66d9ef">each</span>.<span style="color:#66d9ef">value</span>)) <span style="color:#960050;background-color:#1e0010">-</span> <span style="color:#ae81ff">1</span>])
}
</code></pre></div><h2 id="no-caveats">no caveats!</h2>
<p>The caveat from Andy&rsquo;s post around deleting files that are no longer in the list
is not an issue any longer. If you remove a file from the folder and run
terraform plan  you will see a deletion.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  - destroy

Terraform will perform the following actions:

  aws_s3_bucket_object.website_files<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;test.html&#34;</span><span style="color:#f92672">]</span> will be destroyed
</code></pre></div><p>Hopefully this will help those who are using terraform to host a site in S3.
I&rsquo;ve been using this to build a maintenance holding page for emergency
situations where the main application is down.</p>


</main><footer>
  <div>&copy; Lawrence Goldstien</div>
  <a href="/privacy">Privacy</a>
  <div>My opinions are my own</div>
</footer>
<div id="tracker"></div>
<script src="/app.js"></script>
</body>
</html>
