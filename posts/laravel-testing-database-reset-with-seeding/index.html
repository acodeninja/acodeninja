<!DOCTYPE html>
<html class="light" lang="en"><head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  <meta name="description"
        content="Testing a Laravel application has a low barrier to entry compared to other PHP frameworks . What happens when you want to nuke the database between tests? I thought I&amp;rsquo;d share a solution here.
feature testing One of the great features Laravel provides is the ability to refresh your database after each test. This has been really useful, but I needed to test verbs like DELETE and a simple php artisan migrate:fresh isn&amp;rsquo;t all that useful when you have seeds that add information to your database that your tests rely on."
  />
  <meta name="keywords"
        content="software developer, coder, learning to code, laravel, testing, database seeding, test case, acceptance testing"
  />

  <link rel="canonical" href="/posts/laravel-testing-database-reset-with-seeding/" />

  <title>laravel testing: database reset with seeding | Adventures of a code ninja</title>

  <link rel="stylesheet" media="all" href="/all.css"/>
  <link rel="stylesheet" media="screen" href="/screen.css"/>
  <link rel="stylesheet" media="screen" href="/app.css"/>
</head>
<body><header>
  <nav>
    <a href="/">
      
        adventures of a code ninja
      
    </a>
    <ul>
      
        <li>
          <a href="/posts">
            blog
          </a>
        </li>
      
    </ul>
    <div id="theme-toggle"></div>
  </nav>
</header>
<main>
  <h1>laravel testing: database reset with seeding</h1>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#feature-testing">feature testing</a></li>
    <li><a href="#what-about-dusk">what about dusk?</a></li>
  </ul>
</nav>
  <br><br>
  <p>Testing a <a href="https://laravel.com/docs/5.7/testing" target="_blank" rel="noreferrer noopener">Laravel</a>
 application has a low
barrier to entry compared to <a href="https://symfony.com/doc/current/testing.html" target="_blank" rel="noreferrer noopener">other</a>

<a href="https://www.codeigniter.com/user_guide/libraries/unit_testing.html" target="_blank" rel="noreferrer noopener">PHP</a>

<a href="https://book.cakephp.org/3.0/en/development/testing.html" target="_blank" rel="noreferrer noopener">frameworks</a>
. What
happens when you want to nuke the database between tests? I thought I&rsquo;d share a
solution here.</p>
<h2 id="feature-testing">feature testing</h2>
<p>One of the great features Laravel provides is the ability to
<a href="https://laravel.com/docs/5.7/database-testing#resetting-the-database-after-each-test" target="_blank" rel="noreferrer noopener">refresh</a>

your database after each test. This has been really useful, but I needed to
test verbs like <code>DELETE</code> and a simple <code>php artisan migrate:fresh</code>  isn&rsquo;t all
that useful when you have seeds that add information to your database that your
tests rely on.</p>
<p>The class <code>Illuminate\Foundation\Testing\RefreshDatabase</code>  has a method used to
action the refresh refreshTestDatabase  which just calls out to <code>artisan</code> for
the <code>migrate:fresh</code> command. Step in my nice little override:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">// tests/ResetsDatabase.php
</span><span style="color:#75715e"></span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">Tests</span>;

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Contracts\Console\Kernel</span>; 
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Foundation\Testing\RefreshDatabase</span>; 
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Foundation\Testing\RefreshDatabaseState</span>;

<span style="color:#66d9ef">trait</span> <span style="color:#a6e22e">ResetsDatabase</span> {
    <span style="color:#66d9ef">use</span> <span style="color:#a6e22e">RefreshDatabase</span>;
    
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">refreshTestDatabase</span>()
    {
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span> <span style="color:#a6e22e">RefreshDatabaseState</span><span style="color:#f92672">::</span>$migrated) {
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">artisan</span>(<span style="color:#e6db74">&#39;migrate:fresh&#39;</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">shouldDropViews</span>() <span style="color:#f92672">?</span> [
                <span style="color:#e6db74">&#39;--drop-views&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>,
            ] <span style="color:#f92672">:</span> []);

            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">artisan</span>(<span style="color:#e6db74">&#39;db:seed&#39;</span>, []);
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">artisan</span>(<span style="color:#e6db74">&#39;db:seed&#39;</span>, [
                <span style="color:#e6db74">&#39;--class&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;TestDatabaseSeeder&#39;</span>,
            ]);

            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">app</span>[<span style="color:#a6e22e">Kernel</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setArtisan</span>(<span style="color:#66d9ef">null</span>);

            <span style="color:#a6e22e">RefreshDatabaseState</span><span style="color:#f92672">::</span>$migrated <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
        }

        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">beginDatabaseTransaction</span>();
    }
}
</code></pre></div><p>You can use this in your tests the same way you would the RefreshDatabase
class. But instead of just refreshing the database, you will get db:seed for
free along with any test seeds you want to run.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">// tests/Feature/UserApiTest.php
</span><span style="color:#75715e"></span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">Tests\Feature</span>;

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Tests\ResetsDatabase</span>; 
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Tests\TestCase</span>;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserApiTest</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">TestCase</span> {
    <span style="color:#66d9ef">use</span> <span style="color:#a6e22e">ResetsDatabase</span>;
}
</code></pre></div><h2 id="what-about-dusk">what about dusk?</h2>
<p>The same can be achieved in dusk [https://laravel.com/docs/5.7/dusk]  with a
similar change in the DatabaseMigrations  trait provided for resetting the
database.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">// tests/ResetsDatabaseInDusk.php
</span><span style="color:#75715e"></span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">Tests</span>;

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Contracts\Console\Kernel</span>; 
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Foundation\Testing\DatabaseMigrations</span>; 
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Foundation\Testing\RefreshDatabaseState</span>;

<span style="color:#66d9ef">trait</span> <span style="color:#a6e22e">ResetsDatabaseInDusk</span> {
    <span style="color:#66d9ef">use</span> <span style="color:#a6e22e">DatabaseMigrations</span>;
    
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">runDatabaseMigrations</span>()
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">artisan</span>(<span style="color:#e6db74">&#39;migrate:fresh&#39;</span>, [
            <span style="color:#e6db74">&#39;--drop-views&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>,
        ]);

        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">artisan</span>(<span style="color:#e6db74">&#39;db:seed&#39;</span>, []);
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">artisan</span>(<span style="color:#e6db74">&#39;db:seed&#39;</span>, [
            <span style="color:#e6db74">&#39;--class&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;TestDatabaseSeeder&#39;</span>,
        ]);

        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">app</span>[<span style="color:#a6e22e">Kernel</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setArtisan</span>(<span style="color:#66d9ef">null</span>);

        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">beforeApplicationDestroyed</span>(<span style="color:#66d9ef">function</span> () {
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">artisan</span>(<span style="color:#e6db74">&#39;migrate:rollback&#39;</span>);

            <span style="color:#a6e22e">RefreshDatabaseState</span><span style="color:#f92672">::</span>$migrated <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
        });
    }
}
</code></pre></div><p>This will do the same as the previous trait but for your Browser tests.</p>


</main><footer>
  <div>&copy; Lawrence Goldstien</div>
  <a href="/privacy">Privacy</a>
  <div>My opinions are my own</div>
</footer>
<div id="tracker"></div>
<script src="/app.js"></script>
</body>
</html>
