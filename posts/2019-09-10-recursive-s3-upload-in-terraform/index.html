<!doctype html><html lang=en><head><title>recursive file upload to s3 in terraform ::
acode.ninja — Adventures of a code ninja</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I&amp;rsquo;ve been working a lot with HashiCorp&amp;rsquo;s terraform recently. From learning how to set up a highly available container based infrastructure using AWS ECS, to setting up a CloudFront distribution for a static site hosted on S3.
One problem I have had to solve a number of times, is uploading the contents of a directory recursively to an S3 bucket. With the help of a post from Andy Dote&amp;rsquo;s blog, I was able to get some files uploaded."><meta name=keywords content="software developer,coder,learning to code,terraform,aws s3,recursive upload,infrastructure as code"><meta name=robots content="noodp"><link rel=canonical href=/posts/2019-09-10-recursive-s3-upload-in-terraform/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="recursive file upload to s3 in terraform"><meta name=twitter:description content="I&rsquo;ve been working a lot with HashiCorp&rsquo;s terraform recently. From learning how to set up a highly available container based infrastructure using AWS ECS, to setting up a CloudFront distribution for a static site hosted on S3.
One problem I have had to solve a number of times, is uploading the contents of a directory recursively to an S3 bucket. With the help of a post from Andy Dote&rsquo;s blog, I was able to get some files uploaded."><meta property="og:title" content="recursive file upload to s3 in terraform"><meta property="og:description" content="I&rsquo;ve been working a lot with HashiCorp&rsquo;s terraform recently. From learning how to set up a highly available container based infrastructure using AWS ECS, to setting up a CloudFront distribution for a static site hosted on S3.
One problem I have had to solve a number of times, is uploading the contents of a directory recursively to an S3 bucket. With the help of a post from Andy Dote&rsquo;s blog, I was able to get some files uploaded."><meta property="og:type" content="article"><meta property="og:url" content="/posts/2019-09-10-recursive-s3-upload-in-terraform/"><meta property="article:published_time" content="2019-09-10T00:00:00+00:00"><meta property="article:modified_time" content="2019-09-10T00:00:00+00:00"><meta property="og:site_name" content="acode.ninja"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>acode.ninja</span>
<span class=logo__cursor></span></a><span class=header__right><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>recursive file upload to s3 in terraform</h1><div class=post-meta><span class=post-date>2019-09-10</span>
<span class=post-read-time>— 3 min read</span></div><div class=post-content><p>I&rsquo;ve been working a lot with <a href=https://www.hashicorp.com/>HashiCorp&rsquo;s</a>
<a href=https://www.hashicorp.com/products/terraform>terraform</a> recently. From
learning how to set up a <a href=https://learn.madetech.com/core-skills/infrastructure/>highly available container based infrastructure</a>
using <a href=https://aws.amazon.com/ecs/>AWS ECS</a>, to setting up a
<a href=https://aws.amazon.com/cloudfront/>CloudFront</a> distribution for a static site
hosted on <a href=https://aws.amazon.com/s3/>S3</a>.</p><p>One problem I have had to solve a number of times, is uploading the contents of
a directory recursively to an S3 bucket. With the help of a
<a href=https://andydote.co.uk/2017/04/23/s3-multi-file-upload-terraform/>post</a> from
Andy Dote&rsquo;s blog, I was able to get some files uploaded. However I didn&rsquo;t like
the idea of writing a .tf file from a bash script, so I wanted do this
completely inside terraform.</p><h2 id=creating-the-s3-bucket>creating the S3 bucket</h2><p>To begin with, we need an S3 bucket defined in our terraform project. The code
block below comes with a website block that sets up web hosting for the bucket.</p><div class=collapsable-code><input id=387524691 type=checkbox>
<label for=387524691><span class=collapsable-code__language>hcl</span>
<span class=collapsable-code__title>S3 Webhosting Bucket</span>
<span class=collapsable-code__toggle data-label-expand=△ data-label-collapse=▽></span></label><pre class=language-hcl><code>
resource &#34;aws_s3_bucket&#34; &#34;s3_static&#34; {
  bucket  = &#34;testing-website-static-hosting&#34;
  acl     = &#34;public-read&#34;

  website {
    index_document = &#34;index.html&#34;
    error_document = &#34;error.html&#34;
  }
}
</code></pre></div><h2 id=uploading-multiple-files>uploading multiple files</h2><p>Now we need get a set of files from a local directory containing the website
using the <a href=https://www.terraform.io/docs/configuration/functions/fileset.html>fileset</a>
function.</p><p>We then feed that into the <code>for_each</code> to iterate over the set of files and
directories matched by the glob. We then continue much in the same way we did in
Andy&rsquo;s post, but leveraging the <code>each.value</code> property in place of the full
filename.</p><p>The mimetypes variable is used with the file extension taken from the file
path split on <code>.</code>.</p><div class=collapsable-code><input id=643918275 type=checkbox>
<label for=643918275><span class=collapsable-code__language>hcl</span>
<span class=collapsable-code__title>S3 recursive file upload</span>
<span class=collapsable-code__toggle data-label-expand=△ data-label-collapse=▽></span></label><pre class=language-hcl><code>
variable &#34;upload_directory&#34; {
  default = &#34;${path.cwd}/codebases/website-static/&#34;
}

variable &#34;mime_types&#34; {
  default = {
    htm   = &#34;text/html&#34;
    html  = &#34;text/html&#34;
    css   = &#34;text/css&#34;
    ttf   = &#34;font/ttf&#34;
    js    = &#34;application/javascript&#34;
    map   = &#34;application/javascript&#34;
    json  = &#34;application/json&#34;
  }
}

resource &#34;aws_s3_bucket_object&#34; &#34;website_files&#34; {
  for_each      = fileset(var.upload_directory, &#34;**/*.*&#34;)
  bucket        = aws_s3_bucket.s3_static.bucket
  key           = replace(each.value, var.upload_directory, &#34;&#34;)
  source        = &#34;${var.upload_directory}${each.value}&#34;
  acl           = &#34;public-read&#34;
  etag          = filemd5(&#34;${var.upload_directory}${each.value}&#34;)
  content_type  = lookup(local.mime_types, split(&#34;.&#34;, each.value)[length(split(&#34;.&#34;, each.value)) - 1])
}
</code></pre></div><h2 id=no-caveats>no caveats!</h2><p>The caveat from Andy&rsquo;s post around deleting files that are no longer in the list
is not an issue any longer. If you remove a file from the folder and run
terraform plan you will see a deletion.</p><div class=collapsable-code><input id=674391852 type=checkbox>
<label for=674391852><span class=collapsable-code__language>shell script</span>
<span class=collapsable-code__title>Output of <code>terraform plan</code></span>
<span class=collapsable-code__toggle data-label-expand=△ data-label-collapse=▽></span></label><pre class="language-shell script"><code>
An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  - destroy

Terraform will perform the following actions:

  aws_s3_bucket_object.website_files[&#34;test.html&#34;] will be destroyed
</code></pre></div><p>Hopefully this will help those who are using terraform to host a site in S3.
I&rsquo;ve been using this to build a maintenance holding page for emergency
situations where the main application is down.</p></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user">Lawrence Goldstien</div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div></body></html>